services:
  nginx:
    image: ghcr.io/misraaks/nginx-sni-proxy:latest
    restart: unless-stopped
    network_mode: "service:gluetun"
    environment:
      # Defaults to Cloudflare if not set in .env
      - RESOLVER_IP=${NGINX_RESOLVER:-1.1.1.1 1.0.0.1}
      - RESOLVER_OPTIONS=${NGINX_RESOLVER_OPTIONS}
    # FIX: Use single quotes for sh -c, and double quotes for sed to allow variable expansion
    command: >
      /bin/sh -c '
      sed -i "s/resolver 1.1.1.1 1.0.0.1;/resolver $${RESOLVER_IP} $${RESOLVER_OPTIONS};/" /etc/nginx/nginx.conf &&
      nginx -g "daemon off;"
      '

  gluetun:
    image: qmcgaw/gluetun:v3
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      # Bind to IPv4
      - "${HOST_BIND_IPV4:-0.0.0.0}:80:80"
      - "${HOST_BIND_IPV4:-0.0.0.0}:443:443"
      # Bind to IPv6
      - "[${HOST_BIND_IPV6:-::}]:80:80"
      - "[${HOST_BIND_IPV6:-::}]:443:443"
    environment:
      - VPN_SERVICE_PROVIDER=custom
      - VPN_TYPE=wireguard
      - WIREGUARD_ENDPOINT_IP=${WIREGUARD_ENDPOINT}
      - WIREGUARD_ENDPOINT_PORT=${WIREGUARD_ENDPOINT_PORT}
      - WIREGUARD_PUBLIC_KEY=${WIREGUARD_PUBLIC_KEY}
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES}
      - WIREGUARD_PRESHARED_KEY=${WIREGUARD_PRESHARED_KEY}
      - WIREGUARD_IMPLEMENTATION=${WIREGUARD_IMPLEMENTATION}
      - WIREGUARD_MTU=${WIREGUARD_MTU}
      - WIREGUARD_PERSISTENT_KEEPALIVE_INTERVAL=${WIREGUARD_PERSISTENT_KEEPALIVE_INTERVAL}
      - WIREGUARD_ALLOWED_IPS=${WIREGUARD_ALLOWED_IPS}
      - FIREWALL_OUTBOUND_SUBNETS=${FIREWALL_OUTBOUND_SUBNETS}
    restart: unless-stopped
